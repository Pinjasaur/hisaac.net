<!DOCTYPE html>
<html lang="en-us">





<head>

	<title>

		Solo Project Day Seven: To The Database and Back Again

	</title>
	<meta name="apple-mobile-web-app-title" content="
	
		Solo Project Day Seven: To The Database and Back Again
	
" />
	<meta id="description" name="description" content="
	
		The personal weblog of Isaac Halvorson
	
" />


	<meta name="twitter:card" content="summary" />
	<meta name="twitter:title" content="
	
		Solo Project Day Seven: To The Database and Back Again
	
" />
	<meta name="twitter:description" content="
	
		The personal weblog of Isaac Halvorson
	
" />
	<meta name="twitter:site" content="@hisaac" />


	<link rel="stylesheet" href="/css/main.css" />




	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
	<header>
		<h1><a href="/" alt="hisaac.blog">hisaac.blog</a></h1>

		<nav>
			<a href="https://hisaac.net">about</a> •
			<a href="/canon.html">canon</a> •
			<a href="/artifacts.html">artifacts</a> •
			<a href="/now.html">now</a>
		</nav>
	</header>




	<article>
		<h1>Solo Project Day Seven: To The Database and Back Again</h1>


		<div class="post-meta">
			<p><time datetime="2016-12-12 21:10:56 -0600 CST">Monday, Dec 12, 2016</time></p>

		</div>


		<section class="content">


			<p>This is technically the eighth day since I began my solo project, but I didn&rsquo;t do any work on the project on Sunday (although I did do <a href="{% post_url /2016/2016-12-11-moved-to-digital-ocean-lets-encrypt %}">some other web work</a>).</p>

			<p>Today was a very productive day for me. I got more done than I expected to, and I made it to MVP (Minimum Viable Product)! I didn&rsquo;t think I&rsquo;d get to MVP this fast, but I&rsquo;m glad I did. At Prime, we all get industry mentors to work
				with, and tomorrow we meet with them to show them our solo projects. I was really hoping I&rsquo;d have a usable product to show them.</p>

			<h3 id="tasks-accomplished">Tasks Accomplished</h3>

			<ul>
				<li>Sorted out asynchronous tasks on the login page so that writing data returned from Firebase to the database happened <em>after</em> the data was actually received.</li>
				<li>Figured out how to use <code>$location</code> to redirect to a new page after login: <code>$location.path('/drafts')</code></li>
				<li>This one was a doozie. I figured out how to create a new blank Mongoose sub-document upon the press of the &ldquo;new tweet&rdquo; button. Here&rsquo;s the code (authFactory is where I&rsquo;m storing the currently logged in user&rsquo;s data):</li>
			</ul>
			<div class="highlight">
				<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// client side
</span><span style="color:#75715e"></span><span style="color:#a6e22e">$http</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#39;/db/draft/newBlank&#39;</span>, <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">authFactory</span>)
  .<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">res</span>){
    <span style="color:#75715e">// move info from newly created blank draft into draft factory
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">draftFactory</span>.<span style="color:#a6e22e">_id</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">_id</span>;
    <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">draftFactory</span>.<span style="color:#a6e22e">text</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">text</span>;
    <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">draftFactory</span>.<span style="color:#a6e22e">dateCreated</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">dateCreated</span>;
  });

<span style="color:#75715e">// server side
</span><span style="color:#75715e"></span><span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#39;/draft/newBlank&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>){
  <span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">findOne</span>({ <span style="color:#a6e22e">uid</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">uid</span> }, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">error</span>, <span style="color:#a6e22e">user</span>){
    <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">drafts</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Draft</span>);
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">error</span>){
      <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">sendStatus</span>(<span style="color:#ae81ff">500</span>);
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">save</span>();
      <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">201</span>).<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">drafts</span>[<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">drafts</span>.<span style="color:#a6e22e">length</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]);
    }
  });
});</code></pre>
			</div>
			<ul>
				<li>I then figured out how to move the edited text of a draft into the database. This was also difficult, as I had to query the database for the specific draft that was being edited, and then update that one. Here&rsquo;s the code:</li>
			</ul>
			<div class="highlight">
				<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// client side
</span><span style="color:#75715e"></span><span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">saveDraft</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(){
  <span style="color:#a6e22e">$http</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#39;/db/draft/saveDraft/&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">draftFactory</span>.<span style="color:#a6e22e">text</span>, <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">draftFactory</span>);
};

<span style="color:#75715e">// server side
</span><span style="color:#75715e"></span><span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#39;/draft/saveDraft/:tweetText&#39;</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>){
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">query</span> <span style="color:#f92672">=</span> { <span style="color:#e6db74">&#39;drafts._id&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">_id</span> };
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">update</span> <span style="color:#f92672">=</span> { <span style="color:#e6db74">&#39;drafts.$.text&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">tweetText</span> };
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">upsert</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">new</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">setDefaultsOnInsert</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> };

  <span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">findOneAndUpdate</span>(<span style="color:#a6e22e">query</span>, <span style="color:#a6e22e">update</span>, <span style="color:#a6e22e">options</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">error</span>, <span style="color:#a6e22e">result</span>){
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">error</span>){
      <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">sendStatus</span>(<span style="color:#ae81ff">500</span>);
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">sendStatus</span>(<span style="color:#ae81ff">201</span>);
    }
  });
});</code></pre>
			</div>
			<ul>
				<li>Lastly, I queried the database to display the current user&rsquo;s drafts on the Drafts page in a list.</li>
			</ul>

			<p>Tomorrow&rsquo;s task will be mainly styling. I want the app to look nice for my mentors.</p>

			<h3 id="today-s-research">Today&rsquo;s Research</h3>

			<ul>
				<li><a href="http://stackoverflow.com/questions/13195283/mongodb-getting-the-id-of-the-newly-pushed-embedded-object">getting the id of the newly pushed embedded object - Stack Overflow</a> - I needed to get this data when I created a new blank draft.
					Turns out, it&rsquo;s just basic JavaScript (<code>array.length - 1</code>). I shoulda known.</li>
				<li><a href="http://stackoverflow.com/questions/21006222/factory-not-keeping-data-when-used-in-controller">Factory not keeping data when used in controller - Stack Overflow</a> - This was frustrating. I initially was trying to assign objects directly
					to my factories, but I found that I had to assign specific values to them instead (see the first client side code example above). I still don&rsquo;t know <em>why</em> I need to do it this way, but I know that it does work.</li>
			</ul>

		</section>
	</article>



	<footer>
		<p>
			<small>&copy; <span id="yearRange"></span>, <a href="https://hisaac.net">Isaac Halvorson</a></small>
		</p>
		<p>
			<small>
			<a href="mailto:hello@hisaac.net" alt="hello@hisaac.net">email</a> •
			<a href="https://twitter.com/hisaac" alt="@hisaac on Twitter">twitter</a> •
			<a href="https://github.com/hisaac/">github</a> •
			<a href="https://hisaac.blog/index.xml" alt="The Solo Project Day Seven: To The Database and Back Again RSS feed">rss</a>
		</small>
		</p>
	</footer>

</body>

<script type="text/javascript">
	document.getElementById("yearRange").innerHTML = "2008–" + new Date().getFullYear();

</script>

</html>
